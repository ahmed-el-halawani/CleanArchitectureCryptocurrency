name: Build & Release (Reusable)

on:
  workflow_call:
    outputs:
      tag_name:
        description: "Release tag created"
        value: ${{ jobs.build_release.outputs.tag_name }}
      apk_name:
        description: "APK filename"
        value: ${{ jobs.build_release.outputs.apk_name }}

jobs:
  build_release:
    runs-on: ubuntu-latest

    # ⚠️ Access Production Secrets (if you store any in environment)
    environment: production

    permissions:
      contents: write

    outputs:
      tag_name: ${{ steps.meta.outputs.tag_name }}
      apk_name: ${{ steps.meta.outputs.apk_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Bump Version Code
        run: |
          if [ -f "app/build.gradle.kts" ]; then
             sed -i 's/versionCode\s*=\s*[0-9]*/versionCode = ${{ github.run_number }}/' app/build.gradle.kts || true
          fi
          if [ -f "app/build.gradle" ]; then
             sed -i 's/versionCode\s[0-9]*/versionCode ${{ github.run_number }}/' app/build.gradle || true
          fi
          echo "Updated versionCode to ${{ github.run_number }}"

      - name: Build APK (Debug)
        run: ./gradlew assembleDebug --stacktrace

      - name: Rename APK
        run: |
          APK_SRC="app/build/outputs/apk/debug/app-debug.apk"
          if [ ! -f "$APK_SRC" ]; then
            echo "Could not find $APK_SRC"
            echo "Available APKs:"
            find app/build/outputs/apk -name "*.apk" -maxdepth 5 -print || true
            exit 1
          fi

          APK_NAME="app-v1.0.${{ github.run_number }}.apk"
          mv "$APK_SRC" "$APK_NAME"
          echo "APK moved to: $APK_NAME"

      - name: Set metadata outputs
        id: meta
        run: |
          echo "tag_name=v1.0.${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "apk_name=app-v1.0.${{ github.run_number }}.apk" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.meta.outputs.tag_name }}
          name: Release ${{ steps.meta.outputs.tag_name }}
          body: |
            Automatic build #${{ github.run_number }}
            - Version Code: ${{ github.run_number }}
            - Branch: ${{ github.ref_name }}
          files: ${{ steps.meta.outputs.apk_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
